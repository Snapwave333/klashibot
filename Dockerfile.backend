# Backend Dockerfile
FROM python:3.10-slim

# Install system dependencies for Playwright and general build tools
RUN apt-get update && apt-get install -y \
    wget \
    gnupg \
    sox \
    ffmpeg \
    libsndfile1 \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Copy requirements first to leverage cache
COPY requirements.txt .

# Install Python dependencies
RUN pip install --no-cache-dir -r requirements.txt

# Install Playwright browsers
RUN playwright install chromium
RUN playwright install-deps

# Copy the rest of the application code
COPY . .

# Install Qwen3-TTS
RUN pip install -e ./Qwen3-TTS

# Expose ports
EXPOSE 8766 8767

# Set environment variables
ENV PYTHONUNBUFFERED=1
ENV WEBSOCKET_HOST=0.0.0.0
# Assuming Ollama runs on host, use host.docker.internal or configured URL
ENV OLLAMA_HOST=http://host.docker.internal:11434 

# Command to run the application
CMD ["python", "websocket_bridge.py"]
